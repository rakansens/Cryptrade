<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pattern Deletion Debug</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #e0e0e0;
      padding: 20px;
      margin: 0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 {
      color: #22c55e;
    }
    .test-section {
      background: #1a1a1a;
      border: 1px solid #333;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    button {
      background: #22c55e;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      margin: 5px;
      font-size: 14px;
    }
    button:hover {
      background: #16a34a;
    }
    button.danger {
      background: #ef4444;
    }
    button.danger:hover {
      background: #dc2626;
    }
    .log {
      background: #0f0f0f;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 15px;
      height: 600px;
      overflow-y: auto;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 12px;
      line-height: 1.5;
    }
    .log-entry {
      margin-bottom: 5px;
    }
    .log-entry.error { color: #ef4444; }
    .log-entry.success { color: #22c55e; }
    .log-entry.warning { color: #f59e0b; }
    .log-entry.info { color: #3b82f6; }
    .log-entry.debug { color: #8b5cf6; }
    .status {
      background: #0f0f0f;
      border: 1px solid #333;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
    }
    .status-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .status-item label {
      color: #999;
    }
    .status-item value {
      color: #22c55e;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” ãƒ‘ã‚¿ãƒ¼ãƒ³å‰Šé™¤ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h1>
    
    <div class="test-section">
      <h2>1. ãƒ‘ã‚¿ãƒ¼ãƒ³ä½œæˆ</h2>
      <button onclick="createTestPattern()">ãƒ‘ã‚¿ãƒ¼ãƒ³ä½œæˆï¼ˆæ‰¿èªä»˜ãï¼‰</button>
      <button onclick="createMultiplePatterns()">è¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ä½œæˆ</button>
      <button onclick="clearAllPatterns()" class="danger">å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚¯ãƒªã‚¢</button>
    </div>
    
    <div class="test-section">
      <h2>2. å‰Šé™¤ãƒ†ã‚¹ãƒˆ</h2>
      <button onclick="simulateCancelButton()">å–ã‚Šæ¶ˆã—ãƒœã‚¿ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</button>
      <button onclick="deleteLastPattern()">æœ€å¾Œã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å‰Šé™¤</button>
      <button onclick="checkPatternRenderer()">PatternRendererçŠ¶æ…‹ã‚’ç¢ºèª</button>
    </div>
    
    <div class="test-section">
      <h2>3. ãƒ‡ãƒãƒƒã‚°æƒ…å ±</h2>
      <div class="status" id="statusPanel">
        <div class="status-item">
          <label>ä½œæˆã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³æ•°:</label>
          <value id="patternCount">0</value>
        </div>
        <div class="status-item">
          <label>æœ€å¾Œã®ãƒ‘ã‚¿ãƒ¼ãƒ³ID:</label>
          <value id="lastPatternId">-</value>
        </div>
        <div class="status-item">
          <label>PatternRendererçŠ¶æ…‹:</label>
          <value id="rendererState">æœªç¢ºèª</value>
        </div>
      </div>
    </div>
    
    <div class="test-section">
      <h2>ãƒ­ã‚°</h2>
      <button onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
      <div class="log" id="testLog"></div>
    </div>
  </div>

  <script>
    let createdPatterns = [];
    let patternCounter = 0;
    
    // ã‚ªãƒªã‚¸ãƒŠãƒ«ã®consoleãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä¿å­˜
    const originalLog = console.log;
    const originalError = console.error;
    const originalWarn = console.warn;
    const originalInfo = console.info;
    
    // consoleãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
    console.log = function(...args) {
      const message = args.join(' ');
      if (message.includes('[PatternRenderer]') || 
          message.includes('[Agent Event]') || 
          message.includes('[ChatPanel]') ||
          message.includes('pattern') ||
          message.includes('metric')) {
        log(message, 'debug');
      }
      originalLog.apply(console, args);
    };
    
    console.error = function(...args) {
      const message = args.join(' ');
      log(`ERROR: ${message}`, 'error');
      originalError.apply(console, args);
    };
    
    console.warn = function(...args) {
      const message = args.join(' ');
      log(`WARN: ${message}`, 'warning');
      originalWarn.apply(console, args);
    };
    
    console.info = function(...args) {
      const message = args.join(' ');
      if (message.includes('[PatternRenderer]') || 
          message.includes('[Agent Event]') || 
          message.includes('pattern')) {
        log(message, 'info');
      }
      originalInfo.apply(console, args);
    };
    
    function log(message, type = 'info') {
      const logDiv = document.getElementById('testLog');
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      const timestamp = new Date().toLocaleTimeString('ja-JP', { hour12: false, fractionalSecondDigits: 3 });
      entry.textContent = `[${timestamp}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }
    
    function updateStatus() {
      document.getElementById('patternCount').textContent = createdPatterns.length;
      document.getElementById('lastPatternId').textContent = createdPatterns.length > 0 ? createdPatterns[createdPatterns.length - 1] : '-';
    }
    
    function createTestPattern() {
      patternCounter++;
      const timestamp = Date.now();
      const proposalId = `proposal_${timestamp}`;
      const patternId = `drawing_pattern_${timestamp}_pattern_${timestamp}_${patternCounter}`;
      
      log(`ãƒ‘ã‚¿ãƒ¼ãƒ³ä½œæˆé–‹å§‹: ${patternId}`, 'info');
      
      // æ‰¿èªã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
      const approveEvent = new CustomEvent('proposal:approve', {
        detail: {
          proposalId: proposalId,
          drawingData: {
            type: 'pattern',
            points: [
              { time: Date.now() / 1000 - 7200, value: 44000 },
              { time: Date.now() / 1000 - 3600, value: 46000 },
              { time: Date.now() / 1000, value: 44500 }
            ],
            metadata: {
              patternType: 'head_and_shoulders',
              metrics: {
                target_level: 47000,
                stop_loss: 43000,
                breakout_level: 45500
              }
            }
          }
        }
      });
      
      window.dispatchEvent(approveEvent);
      
      // ãƒ‘ã‚¿ãƒ¼ãƒ³è¿½åŠ ã‚¤ãƒ™ãƒ³ãƒˆ
      const pattern = {
        id: patternId,
        type: 'head_and_shoulders',
        visualization: {
          keyPoints: [
            { time: Date.now() / 1000 - 7200, value: 44000 },
            { time: Date.now() / 1000 - 3600, value: 46000 },
            { time: Date.now() / 1000, value: 44500 }
          ],
          lines: [
            { from: 0, to: 1, style: { color: '#22c55e', lineWidth: 2 } },
            { from: 1, to: 2, style: { color: '#22c55e', lineWidth: 2 } }
          ]
        },
        metrics: {
          target_level: 47000,
          stop_loss: 43000,
          breakout_level: 45500
        }
      };
      
      const addEvent = new CustomEvent('chart:addPattern', {
        detail: { id: patternId, pattern: pattern }
      });
      
      window.dispatchEvent(addEvent);
      
      createdPatterns.push(patternId);
      updateStatus();
      
      log(`ãƒ‘ã‚¿ãƒ¼ãƒ³ä½œæˆå®Œäº†: ${patternId}`, 'success');
      log(`ãƒ¡ãƒˆãƒªã‚¯ã‚¹: TP=${pattern.metrics.target_level}, SL=${pattern.metrics.stop_loss}, BO=${pattern.metrics.breakout_level}`, 'info');
    }
    
    function createMultiplePatterns() {
      log('è¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½œæˆä¸­...', 'info');
      for (let i = 0; i < 3; i++) {
        setTimeout(() => createTestPattern(), i * 500);
      }
    }
    
    function simulateCancelButton() {
      if (createdPatterns.length === 0) {
        log('å‰Šé™¤ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
        return;
      }
      
      const patternId = createdPatterns[createdPatterns.length - 1];
      log(`å–ã‚Šæ¶ˆã—ãƒœã‚¿ãƒ³ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³: ${patternId}`, 'info');
      
      // å‰Šé™¤å‰ã®çŠ¶æ…‹ã‚’ç¢ºèª
      log('å‰Šé™¤å‰ã®PatternRendererçŠ¶æ…‹ã‚’ç¢ºèª...', 'debug');
      checkPatternRenderer();
      
      // ChatPanelã®handleCancelDrawingã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
      const deleteEvent = new CustomEvent('chart:deleteDrawing', {
        detail: { id: patternId }
      });
      
      log(`å‰Šé™¤ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ: ${patternId}`, 'debug');
      window.dispatchEvent(deleteEvent);
      
      // å‰Šé™¤å¾Œã®ç¢ºèª
      setTimeout(() => {
        log('å‰Šé™¤å¾Œã®PatternRendererçŠ¶æ…‹ã‚’ç¢ºèª...', 'debug');
        checkPatternRenderer();
        
        // ãƒãƒ£ãƒ¼ãƒˆä¸Šã®ç·šã®æ•°ã‚’ç¢ºèª
        const lines = document.querySelectorAll('.tv-lightweight-charts path, .tv-lightweight-charts line');
        log(`ãƒãƒ£ãƒ¼ãƒˆä¸Šã®ç·šã®æ•°: ${lines.length}`, lines.length > 0 ? 'warning' : 'success');
      }, 1500);
    }
    
    function deleteLastPattern() {
      if (createdPatterns.length === 0) {
        log('å‰Šé™¤ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
        return;
      }
      
      const patternId = createdPatterns.pop();
      log(`ç›´æ¥å‰Šé™¤: ${patternId}`, 'info');
      
      const deleteEvent = new CustomEvent('chart:deleteDrawing', {
        detail: { id: patternId }
      });
      
      window.dispatchEvent(deleteEvent);
      updateStatus();
    }
    
    function clearAllPatterns() {
      log('å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã‚¯ãƒªã‚¢ä¸­...', 'warning');
      
      while (createdPatterns.length > 0) {
        const patternId = createdPatterns.pop();
        const deleteEvent = new CustomEvent('chart:deleteDrawing', {
          detail: { id: patternId }
        });
        window.dispatchEvent(deleteEvent);
      }
      
      updateStatus();
      log('å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚¯ãƒªã‚¢å®Œäº†', 'success');
    }
    
    function checkPatternRenderer() {
      log('PatternRendererçŠ¶æ…‹ã‚’ç¢ºèªä¸­...', 'info');
      
      // PatternRendererã®debugGetStateã‚’å‘¼ã³å‡ºã™ã‚¤ãƒ™ãƒ³ãƒˆ
      const debugEvent = new CustomEvent('debug:getPatternRendererState');
      window.dispatchEvent(debugEvent);
      
      // storeã®çŠ¶æ…‹ã‚‚ç¢ºèª
      const storeEvent = new CustomEvent('debug:getStorePatterns');
      window.dispatchEvent(storeEvent);
      
      document.getElementById('rendererState').textContent = 'ç¢ºèªæ¸ˆã¿ï¼ˆãƒ­ã‚°å‚ç…§ï¼‰';
    }
    
    function clearLog() {
      document.getElementById('testLog').innerHTML = '';
      log('ãƒ­ã‚°ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'warning');
    }
    
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¿½åŠ 
    window.addEventListener('pattern:removed', (event) => {
      log(`ãƒ‘ã‚¿ãƒ¼ãƒ³å‰Šé™¤ç¢ºèª: ${event.detail.id}`, 'success');
    });
    
    window.addEventListener('pattern:remove:failed', (event) => {
      log(`ãƒ‘ã‚¿ãƒ¼ãƒ³å‰Šé™¤å¤±æ•—: ${event.detail.id} - ${event.detail.error}`, 'error');
    });
    
    // åˆæœŸåŒ–
    window.addEventListener('load', () => {
      log('ãƒ‘ã‚¿ãƒ¼ãƒ³å‰Šé™¤ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«åˆæœŸåŒ–å®Œäº†', 'success');
      log('ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä½œæˆã—ã¦ã‹ã‚‰å‰Šé™¤ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„', 'info');
      updateStatus();
    });
  </script>
</body>
</html>